---
slug: doc-743mc2
---
# Phase 3.7: MD 编辑器优化

## 最终实现

根据用户反馈，MD 编辑器定位为**纯文档编辑器**，不再实现复杂的语义化 YAML 表单（因为已有独立的"表单"视图）。

### 核心设计原则

- **阅读视图** → 阅读体验优化
- **表单视图** → 结构化数据编辑
- **MD 编辑视图** → 源码级文档编辑

三种视图各司其职，不重复功能。

## 最终架构

```
┌─────────────────────────────────────────────────┐
│  陈七                           × 取消    保存   │  ← 标题栏
├─────────────────────────────────────────────────┤
│  ⚠️ 检测到缺少字段: id, status  [一键补齐]      │  ← 自动补齐提示
├─────────────────────────────────────────────────┤
│  ⓘ 系统元数据（固定键）· 7 项              ∧    │  ← 可折叠
│  ┌─────────┬─────────┬─────────┬─────────┐     │
│  │  版本   │  类型   │  创建   │  更新   │     │
│  │  1.0 ▼  │ 事实文档 │2025/01  │(自动)   │     │
│  ├─────────┼─────────┴─────────┴─────────┤     │
│  │  作者   │  功能    │  能力              │     │
│  │ system  │ 登录主体 │ 认证 会话 [+添加] │     │
│  └─────────┴─────────────────────────────┘     │
│  🔒 标有锁图标的字段由系统自动管理               │
├─────────────────────────────────────────────────┤
│  <> 文档内容（...）·29行  · 支持语法高亮        │
│ ┌────┬────────────────────────────────────────┐│
│ │  1 │ # 陈七 {#u-chenqi}                     ││  ← CodeMirror 编辑器
│ │  2 │                                        ││
│ │  3 │ ```yaml                                ││  ← YAML 语法高亮
│ │  4 │ type: principal                        ││
│ │  5 │ id: u-chenqi                           ││
│ │  6 │ display_name: 陈七                     ││
│ │ .. │ ...                                    ││
│ └────┴────────────────────────────────────────┘│
├─────────────────────────────────────────────────┤
│  联系人/...  1个Block  ⌘S保存 ⌘F搜索 ⌘G跳转行  │  ← 状态栏
└─────────────────────────────────────────────────┘
```

## 实现的功能

### 1. 固定键区（表单编辑）

frontmatter 中的系统元数据字段：

| 字段 | 类型 | 可编辑 | 说明 |
|------|------|--------|------|
| `version` | 下拉选择器 | ✅ | 支持保持/小版本/大版本/手动输入 |
| `document_type` | 下拉选择器 | ✅ | 文档类型（principal/facts/note等） |
| `created` | 日期 | ❌ | 创建时间（只读） |
| `updated` | 日期 | ❌ | 更新时间（保存时自动更新） |
| `author` | 文本 | ✅ | 作者 |
| `atlas.function` | 下拉选择器 | ✅ | 功能声明（根据类型筛选） |
| `atlas.capabilities` | 标签选择 | ✅ | 能力声明（根据功能自动匹配） |

### 2. 文档内容区（CodeMirror 编辑器）

- **语法高亮** - YAML/Markdown 语法着色
- **行号显示** - 左侧行号栏
- **深色主题** - One Dark 主题
- **搜索替换** - Ctrl+F 搜索，Ctrl+H 替换
- **行跳转** - Ctrl+G 跳转到指定行
- **自动缩进** - 括号匹配和自动缩进

### 3. 自动补齐集成

- **缺失字段检测** - 加载时检测文档缺失的必填字段
- **一键补齐提示** - 显示 "⚠️ 检测到缺少字段: xxx [一键补齐]" 
- **保存时自动补齐** - 自动更新 `updated` 时间戳等字段
- **API**: `/api/documents/auto-complete/apply`

### 4. 未保存状态提醒

- **页面标题标记** - 未保存时标题显示 `*`
- **离开确认** - 关闭/刷新页面时弹出确认
- **草稿自动保存** - 每 2 秒自动保存到 localStorage
- **草稿恢复** - 检测到草稿时提示恢复

### 5. 快捷键支持

| 快捷键 | 功能 |
|--------|------|
| `⌘S` / `Ctrl+S` | 保存文档 |
| `⌘F` / `Ctrl+F` | 打开搜索面板 |
| `⌘H` / `Ctrl+H` | 打开替换面板 |
| `⌘G` / `Ctrl+G` | 跳转到指定行 |
| `Esc` | 取消编辑 / 关闭面板 |

## 关键文件

```
frontend/src/components/editor/smart-editor/
├── SmartDocEditor.tsx       # 主编辑器组件
├── CodeMirrorEditor.tsx     # CodeMirror 编辑器封装 (NEW)
├── useEditorState.ts        # 编辑器状态管理
├── fixedKeyConfig.tsx       # 固定键配置
├── FixedKeyField.tsx        # 固定键字段渲染
├── VersionSelector.tsx      # 版本选择器
├── DocumentTypeSelector.tsx # 文档类型选择器
├── FunctionSelector.tsx     # 功能选择器
├── CapabilitiesField.tsx    # 能力字段
└── types.ts                 # 类型定义

frontend/src/api/
└── auto-complete.ts         # 自动补齐 API 客户端 (NEW)
```

## 依赖包

```json
{
  "@codemirror/view": "^6.x",
  "@codemirror/state": "^6.x",
  "@codemirror/language": "^6.x",
  "@codemirror/lang-markdown": "^6.x",
  "@codemirror/lang-yaml": "^6.x",
  "@codemirror/theme-one-dark": "^6.x",
  "@codemirror/commands": "^6.x",
  "@codemirror/search": "^6.x"
}
```

## 用户体验

1. **固定键区** - 表单化编辑 frontmatter
   - 不会写 YAML 的用户可以通过下拉框、标签等控件修改元数据
   
2. **内容区** - 源码级编辑 + 语法高亮
   - 熟悉 Markdown 的用户直接编辑源码
   - 语法高亮提升代码可读性
   - 搜索替换提升编辑效率

3. **自动补齐** - 智能字段管理
   - 自动检测缺失字段
   - 一键补齐减少手动操作
   - 保存时自动更新时间戳

4. **草稿保护** - 防止数据丢失
   - 自动保存草稿
   - 离开提醒
   - 草稿恢复

## 原计划（已废弃）

原计划是在 MD 编辑器中实现 YAML 语义化表单编辑，但用户反馈：

> "不需要再表单化了，因为我们已经有表单视图了，还是文档化，只希望有一种更友好的编辑界面"

因此，MD 编辑器保持为纯文档编辑器，语义化组件（semantic-yaml/*）保留但主要用于"表单"视图中的 Block 渲染。

## 相关 Phase

- **Phase 3.5** - 固定键系统
- **Phase 3.6** - 场景化视图系统（阅读/表单/MD编辑三视图）

## 更新记录

### 2025-01-03 综合优化

- ✅ 集成 CodeMirror 6 编辑器（语法高亮）
- ✅ 添加搜索/替换/行跳转功能
- ✅ 集成 AutoCompleteService（保存时自动补齐）
- ✅ 添加缺失字段检测和一键补齐提示
- ✅ 增强未保存状态提醒（页面标题、离开确认）
- ✅ 实现草稿自动保存和恢复
- ✅ 统一类型定义到 @/types/adl.ts
