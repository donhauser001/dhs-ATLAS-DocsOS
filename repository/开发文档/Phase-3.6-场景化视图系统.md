---
slug: doc-6tdqrk
---
# Phase 3.6: 场景化视图系统 (Scenario-Based View System)

> **核心理念**：不同类型的文档应有不同的展示方式和交互体验，视图根据文档的功能声明自动适配最佳渲染方案。

---

## 〇、设计哲学

### 问题背景

当前 ATLAS 的三种视图模式（阅读、表单、MD编辑）对所有文档都使用相同的渲染逻辑：

```
当前状态：
┌─────────────────────────────────────────────────────┐
│  所有文档                                            │
│  ├── 阅读模式 → 统一的 BlockRenderer                │
│  ├── 表单模式 → 统一的 DocumentEditor               │
│  └── MD编辑  → 统一的 SmartDocEditor                │
└─────────────────────────────────────────────────────┘

问题：
- 用户文档(principal)显示成普通列表，没有用户卡片的直观感
- 项目文档(project)看不到状态看板和时间线
- 客户文档(client)没有项目关联视图
- 笔记文档(note)表单模式没有意义
```

### 核心决策

| 原则 | 说明 |
|------|------|
| **功能驱动视图** | `atlas.function` 决定使用哪个渲染器 |
| **能力驱动操作** | `atlas.capabilities` 决定显示哪些操作按钮 |
| **渐进增强** | 未注册的功能回退到默认渲染器 |
| **配置化** | 视图映射关系可配置，不硬编码 |

### 目标体验

```
目标状态：
┌─────────────────────────────────────────────────────────────┐
│              │    阅读模式      │    表单模式     │   MD编辑  │
│──────────────┼─────────────────┼────────────────┼──────────│
│  principal   │  用户卡片        │  身份表单      │  通用     │
│  client      │  客户档案        │  客户表单      │  通用     │
│  entity_list │  数据表格        │  批量编辑      │  通用     │
│  project     │  状态看板        │  项目表单      │  通用     │
│  note        │  文章阅读        │  (禁用)        │  富文本   │
│  config      │  配置预览        │  配置表单      │  JSON     │
└─────────────────────────────────────────────────────────────┘
```

---

## 一、架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         DocumentPage                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  读取文档 → 获取 atlas.function / capabilities           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              FunctionViewRegistry                        │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  principal → { readView, formView, actions }    │    │    │
│  │  │  client    → { readView, formView, actions }    │    │    │
│  │  │  project   → { readView, formView, actions }    │    │    │
│  │  │  ...                                            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              ViewModeConfig                              │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  principal → ['read', 'form', 'md']             │    │    │
│  │  │  note      → ['read', 'md']  // 无表单模式      │    │    │
│  │  │  ...                                            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  根据 viewMode 选择渲染器                                │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐               │    │
│  │  │ ReadView │  │ FormView │  │ MDEditor │               │    │
│  │  └──────────┘  └──────────┘  └──────────┘               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  ActionBar（根据 capabilities 渲染操作按钮）             │    │
│  │  [编辑] [删除] [重置密码] [禁用账户] ...                 │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心接口定义

```typescript
// 功能视图配置
interface FunctionViewConfig {
  // 功能标识
  function: string;
  
  // 视图组件
  views: {
    read?: React.ComponentType<ViewProps>;   // 阅读视图
    form?: React.ComponentType<ViewProps>;   // 表单视图
    md?: React.ComponentType<ViewProps>;     // MD编辑视图（可选覆盖）
  };
  
  // 可用视图模式
  availableModes: ViewMode[];
  
  // 默认视图模式
  defaultMode: ViewMode;
  
  // 操作按钮
  actions: ActionConfig[];
}

// 视图模式
type ViewMode = 'read' | 'form' | 'md';

// 操作配置
interface ActionConfig {
  id: string;
  label: string;
  icon: string;
  capability?: string;  // 所需能力，用于权限控制
  variant?: 'default' | 'primary' | 'danger';
  handler: string;      // 处理函数名
}

// 视图属性
interface ViewProps {
  document: ADLDocument;
  onSave?: (data: unknown) => Promise<void>;
  onCancel?: () => void;
  readOnly?: boolean;
}
```

---

## 二、场景定义

### 2.1 Principal（登录主体）

**用途**：系统用户、管理员等可登录的实体

**阅读视图**：
```
┌────────────────────────────────────────────────────────┐
│  ┌──────┐                                              │
│  │ 头像 │  陈七                           [编辑] [···] │
│  └──────┘  @u-chenqi · 活跃                            │
│                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                        │
│  📧 联系方式                                           │
│     邮箱: chen-qi@example.com                          │
│     电话: 13893649480                                  │
│                                                        │
│  📁 关联档案                                           │
│     → 联系人/profiles/client-contacts.md#p-chenqi     │
│                                                        │
│  ──────────────────────────────────────────────────── │
│  📄 系统信息                              [展开]       │
│     创建: 2025-01-01 · 版本: 1.0                       │
└────────────────────────────────────────────────────────┘
```

**表单视图**：
```
┌────────────────────────────────────────────────────────┐
│  基本信息                                              │
│  ┌─────────────────────────────────────────────────┐  │
│  │ 显示名称    [陈七                            ]  │  │
│  │ 用户ID      [u-chenqi                        ]  │  │
│  │ 状态        [活跃 ▼]                            │  │
│  └─────────────────────────────────────────────────┘  │
│                                                        │
│  联系方式                                              │
│  ┌─────────────────────────────────────────────────┐  │
│  │ 邮箱        [chen-qi@example.com             ]  │  │
│  │ 电话        [13893649480                     ]  │  │
│  └─────────────────────────────────────────────────┘  │
│                                                        │
│                              [取消]  [保存]            │
└────────────────────────────────────────────────────────┘
```

**操作按钮**：
- `编辑` - 进入表单模式
- `重置密码` - 需要 `auth.login` 能力
- `禁用账户` - 需要 `auth.session` 能力

### 2.2 Client（客户）

**用途**：客户/公司实体

**阅读视图**：
```
┌────────────────────────────────────────────────────────┐
│  🏢 ABC科技有限公司                      [编辑] [···]  │
│     @c-abc-tech · 活跃                                 │
│                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                        │
│  👤 联系人                                             │
│     张三 (销售经理) · zhang@abc.com                    │
│     李四 (技术总监) · li@abc.com                       │
│                                                        │
│  📋 关联项目                                           │
│     → 项目A (进行中)                                   │
│     → 项目B (已完成)                                   │
│                                                        │
│  💰 合同金额: ¥500,000                                 │
└────────────────────────────────────────────────────────┘
```

### 2.3 Entity List（实体列表）

**用途**：数据列表页面

**阅读视图**：
```
┌────────────────────────────────────────────────────────┐
│  客户联系人列表                          [新建] [导出] │
│                                                        │
│  🔍 [搜索...]           状态: [全部 ▼]  类型: [全部 ▼] │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                        │
│  ┌─────────────────────────────────────────────────┐  │
│  │ ☐  姓名      公司        职位       状态        │  │
│  │────────────────────────────────────────────────│  │
│  │ ☐  张三      ABC科技     销售经理    活跃       │  │
│  │ ☐  李四      XYZ公司     技术总监    活跃       │  │
│  │ ☐  王五      DEF集团     项目经理    暂停       │  │
│  └─────────────────────────────────────────────────┘  │
│                                                        │
│  共 3 条记录                          < 1 2 3 ... >    │
└────────────────────────────────────────────────────────┘
```

### 2.4 Project（项目）

**用途**：项目管理

**阅读视图**：
```
┌────────────────────────────────────────────────────────┐
│  🚀 ATLAS 系统开发                       [编辑] [···]  │
│     进行中 · 进度 65%                                  │
│                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  ████████████████████░░░░░░░░░░░░░░░  65%             │
│                                                        │
│  📅 时间线                                             │
│     ├─ 2025-01-01  项目启动                            │
│     ├─ 2025-01-15  Phase 1 完成                        │
│     ├─ 2025-02-01  Phase 2 进行中 ←                    │
│     └─ 2025-03-01  预计交付                            │
│                                                        │
│  👥 团队                                               │
│     负责人: 张三 · 成员: 5人                           │
│                                                        │
│  💰 合同金额: ¥200,000                                 │
└────────────────────────────────────────────────────────┘
```

### 2.5 Note（笔记）

**用途**：自由内容创作

**阅读视图**：
```
┌────────────────────────────────────────────────────────┐
│  📝 如何使用 ATLAS 系统                                │
│     2025-01-03 · 阅读 5 分钟                          │
│                                                        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                        │
│  ## 目录                                               │
│  1. 简介                                               │
│  2. 基本概念                                           │
│  3. 快速开始                                           │
│                                                        │
│  ──────────────────────────────────────────────────── │
│                                                        │
│  ## 1. 简介                                            │
│                                                        │
│  ATLAS 是一个文档驱动的系统，它将文档视为系统的        │
│  核心组成部分...                                       │
│                                                        │
└────────────────────────────────────────────────────────┘
```

**特殊行为**：
- 无表单模式（点击编辑直接进入 MD 编辑）
- 阅读模式专注于排版和可读性

---

## 三、能力与操作映射

### 3.1 能力 → 操作按钮

| 能力 | 操作按钮 | 说明 |
|------|----------|------|
| `auth.login` | 重置密码 | 重置用户密码 |
| `auth.session` | 禁用/启用 | 禁用或启用账户 |
| `crud.update` | 编辑 | 进入编辑模式 |
| `crud.delete` | 删除 | 删除文档 |
| `crud.list` | 导出 | 导出列表数据 |
| `crud.filter` | 筛选 | 显示筛选器 |
| `workflow.status` | 变更状态 | 状态流转下拉菜单 |

### 3.2 ActionBar 组件

```tsx
function ActionBar({ capabilities, function: fn }) {
  const actions = FunctionViewRegistry.get(fn)?.actions || [];
  
  return (
    <div className="action-bar">
      {actions
        .filter(action => !action.capability || capabilities.includes(action.capability))
        .map(action => (
          <ActionButton key={action.id} action={action} />
        ))}
    </div>
  );
}
```

---

## 四、实现计划

### Phase 3.6.1: 基础架构

- [ ] 创建 `FunctionViewRegistry` 视图注册表
- [ ] 创建 `ViewModeConfig` 视图模式配置
- [ ] 改造 `DocumentPage` 支持动态视图选择
- [ ] 创建 `ActionBar` 组件

### Phase 3.6.2: Principal 场景

- [ ] 实现 `PrincipalReadView` 用户卡片视图
- [ ] 实现 `PrincipalFormView` 用户编辑表单
- [ ] 实现 Principal 专属操作按钮

### Phase 3.6.3: 其他场景（后续）

- [ ] Client 场景
- [ ] EntityList 场景
- [ ] Project 场景
- [ ] Note 场景

---

## 五、文件结构

```
frontend/src/
├── registry/
│   ├── FunctionViewRegistry.ts    # 功能→视图映射
│   ├── ViewModeConfig.ts          # 视图模式配置
│   └── index.ts                   # 导出
│
├── components/
│   ├── views/
│   │   ├── principal/
│   │   │   ├── PrincipalReadView.tsx
│   │   │   ├── PrincipalFormView.tsx
│   │   │   └── index.ts
│   │   ├── client/
│   │   ├── entity-list/
│   │   ├── project/
│   │   └── note/
│   │
│   └── action-bar/
│       ├── ActionBar.tsx
│       ├── ActionButton.tsx
│       └── index.ts
│
└── pages/workspace/
    └── DocumentPage.tsx           # 改造支持动态视图
```

---

## 六、验收标准

1. **Principal 文档**在阅读模式下显示用户卡片样式
2. **Principal 文档**在表单模式下显示专属编辑表单
3. **Note 文档**没有表单模式按钮
4. 操作按钮根据 `capabilities` 动态显示/隐藏
5. 未注册功能的文档回退到默认渲染器

