---
slug: doc-fwzg4j
---
# 4.2.16 - 索引增量更新机制

> 优先级: 🟡 中  
> 预估工期: 2 天  
> 依赖任务: 4.2.4  
> 状态: ✅ 已完成

## 任务概述

实现索引增量更新机制，文档保存/删除/移动时自动更新索引。

## 目标

- [x] 文档保存触发增量更新
- [x] 文档删除触发索引清理
- [x] 文档移动触发路径更新
- [x] Checksum 变化检测

## 技术要点

### 触发时机

| 事件 | 处理 |
|------|------|
| 文档保存 | 解析文档，更新/新增用户索引 |
| 文档删除 | 从索引中移除相关用户 |
| 文档移动 | 更新 _doc_path |

### 增量更新流程

```
1. 文件保存到磁盘
2. 触发增量索引
   a. 解析文档，查找 __atlas_user_auth__ 数据块
   b. 如果找到:
      - 计算 checksum
      - 对比现有索引中的 checksum
      - 如果不同，更新索引记录
      - 更新凭证映射（处理凭证变更）
   c. 如果没找到但索引中有该文档:
      - 从索引中移除该用户
      - 清理相关凭证映射
3. 返回操作结果
```

### 凭证变更处理

```typescript
// 用户修改了邮箱
// 旧邮箱: old@example.com
// 新邮箱: new@example.com

// 需要:
// 1. 删除 credentials["old@example.com"]
// 2. 添加 credentials["new@example.com"]
```

## 涉及文件

| 文件 | 修改类型 |
|------|----------|
| `backend/src/services/auth-credential-indexer.ts` | 修改 |
| `backend/src/api/documents.ts` | 修改（添加钩子） |

## 子任务

- [x] Day 1: 实现增量更新逻辑，checksum 检测
- [x] Day 2: 集成到文档保存/删除流程，测试

## 验收标准

1. 保存文档后索引自动更新
2. 删除文档后用户从索引移除
3. 移动文档后路径正确更新
4. 凭证变更正确处理
5. checksum 未变时跳过更新

## 进度记录

| 日期 | 进度 | 备注 |
|------|------|------|
| 2026-01-06 | 100% | 全部完成 |

---

*创建日期: 2026-01-06*  
*完成日期: 2026-01-06*

