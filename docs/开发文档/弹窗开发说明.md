# 弹窗开发说明

> 本文档描述如何在 ATLAS-DocsOS 系统中开发和使用弹窗组件。

---

## 架构概述

弹窗系统采用**表单与框架分离**的设计：

```
表单组件（纯净）  +  框架外壳  =  弹窗
     ↓                 ↓
 业务逻辑         UI 容器
```

**核心原则**：
- 表单组件是**纯净的**，不知道自己在弹窗里
- 同一表单可以用于弹窗、页面、AI 直接调用
- 所有弹窗样式由 `ModalShell` 统一控制

---

## 目录结构

```
frontend/src/
├── components/modal/           # 框架层（一般不需要修改）
│   ├── ModalShell.tsx         # 弹窗 UI 外壳
│   ├── ModalProvider.tsx      # 状态管理 + 事件监听
│   ├── types.ts               # 类型定义
│   └── index.ts               # 导出
│
├── modals/                     # 业务表单
│   ├── service/               # 服务相关弹窗
│   │   ├── CreateServiceForm.tsx
│   │   ├── EditServiceForm.tsx
│   │   └── index.ts
│   ├── category/              # 分类相关弹窗
│   │   ├── CreateCategoryForm.tsx
│   │   ├── EditCategoryForm.tsx
│   │   └── index.ts
│   ├── registry.ts            # 弹窗注册表
│   └── 弹窗开发说明.md         # 本文档
```

---

## 开发新弹窗的步骤

### 第 1 步：创建表单组件

在 `modals/` 目录下创建表单文件：

```tsx
// modals/example/CreateExampleForm.tsx

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Loader } from 'lucide-react'

// 1. 定义表单数据类型
export interface CreateExampleFormData {
  name: string
  description: string
}

// 2. 定义组件 Props（遵循标准接口）
export interface CreateExampleFormProps {
  onSubmit: (data: CreateExampleFormData) => void  // 必需
  onCancel: () => void                              // 必需
  initialData?: Partial<CreateExampleFormData>      // 可选
  submitting?: boolean                              // 框架传入
  error?: string                                    // 框架传入
  // 额外的业务 props...
  defaultName?: string
}

// 3. 实现纯净的表单组件
export function CreateExampleForm({
  onSubmit,
  onCancel,
  initialData,
  submitting,
  error,
  defaultName,
}: CreateExampleFormProps) {
  const [form, setForm] = useState<CreateExampleFormData>({
    name: initialData?.name || defaultName || '',
    description: initialData?.description || '',
  })

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (!form.name.trim()) return
    onSubmit(form)  // 只调用 onSubmit，不关心后续处理
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="space-y-2">
        <label className="text-sm font-medium">名称 *</label>
        <Input
          value={form.name}
          onChange={(e) => setForm({ ...form, name: e.target.value })}
          placeholder="输入名称"
          required
        />
      </div>

      <div className="space-y-2">
        <label className="text-sm font-medium">描述</label>
        <Input
          value={form.description}
          onChange={(e) => setForm({ ...form, description: e.target.value })}
          placeholder="输入描述"
        />
      </div>

      {/* 错误提示（由框架传入） */}
      {error && (
        <div className="text-sm text-destructive bg-destructive/10 px-3 py-2 rounded-md">
          {error}
        </div>
      )}

      {/* 操作按钮 */}
      <div className="flex justify-end gap-3 pt-2">
        <Button type="button" variant="outline" onClick={onCancel}>
          取消
        </Button>
        <Button type="submit" disabled={submitting}>
          {submitting && <Loader className="h-4 w-4 animate-spin mr-2" />}
          创建
        </Button>
      </div>
    </form>
  )
}
```

### 第 2 步：创建索引文件

```tsx
// modals/example/index.ts

export { CreateExampleForm, type CreateExampleFormData } from './CreateExampleForm'
```

### 第 3 步：注册弹窗

在 `modals/registry.ts` 中注册：

```tsx
import { CreateExampleForm, type CreateExampleFormData } from './example'
import { createExample } from '@/api/example'  // API 函数

export const modalRegistry: ModalRegistry = {
  // ... 其他弹窗

  'example.create': {
    component: CreateExampleForm,
    meta: {
      title: '新建示例',      // 弹窗标题
      width: 'lg',            // 宽度：sm | md | lg | xl | 2xl | full
    },
    onSubmit: async (data: CreateExampleFormData, context) => {
      // context.props 包含调用时传入的额外参数
      const result = await createExample(data)
      if (!result.success) {
        throw new Error(result.error?.message || '创建失败')
      }
    },
    invalidateKeys: [['examples']],  // 成功后刷新的 react-query 缓存
  },
}
```

---

## 表单组件规范

### 必须接收的 Props

| Prop | 类型 | 说明 |
|------|------|------|
| `onSubmit` | `(data: T) => void` | 提交表单数据 |
| `onCancel` | `() => void` | 取消操作 |
| `initialData` | `Partial<T>` | 初始数据（可选） |
| `submitting` | `boolean` | 是否正在提交（框架控制） |
| `error` | `string` | 错误信息（框架控制） |

### 禁止事项

- ❌ 不要导入 `ModalShell` 或任何弹窗框架组件
- ❌ 不要在表单内调用 API（API 调用在 registry 的 `onSubmit` 中）
- ❌ 不要管理 `submitting` 和 `error` 状态（由框架管理）
- ❌ 不要调用 `useModal()` hook

### 允许事项

- ✅ 使用 `useState` 管理表单字段
- ✅ 接收额外的业务 props（如 `categories`、`defaultCategory`）
- ✅ 使用 shadcn/ui 组件
- ✅ 进行表单验证

---

## 调用方式

### 方式 1：React 组件调用

```tsx
import { useModal } from '@/components/modal'

function MyPage() {
  const { openModal } = useModal()

  const handleCreate = () => {
    openModal('example.create', {
      // 传递给表单的额外 props
      defaultName: '默认名称',
    })
  }

  return <Button onClick={handleCreate}>新建</Button>
}
```

### 方式 2：AI / 脚本打开弹窗

```javascript
// 打开弹窗，让用户填写
window.dispatchEvent(new CustomEvent('modal:open', {
  detail: {
    id: 'example.create',
    props: {
      defaultName: '默认名称',
    },
    options: {
      initialData: { name: '预填值' },
      onSuccess: () => console.log('创建成功'),
    }
  }
}))
```

### 方式 3：AI / 脚本直接提交（绕过 UI）

```javascript
// 直接提交数据，不显示弹窗
window.dispatchEvent(new CustomEvent('modal:submit', {
  detail: {
    id: 'example.create',
    data: {
      name: '新示例',
      description: '由 AI 创建',
    },
    props: {}, // 额外参数
  }
}))

// 监听结果
window.addEventListener('modal:submit:success', (e) => {
  console.log('提交成功', e.detail.id)
})

window.addEventListener('modal:submit:error', (e) => {
  console.log('提交失败', e.detail.id, e.detail.error)
})
```

---

## 弹窗宽度参考

| 值 | 最大宽度 | 适用场景 |
|----|----------|----------|
| `sm` | 384px | 简单确认框 |
| `md` | 448px | 简单表单（2-3 个字段） |
| `lg` | 512px | 标准表单（默认） |
| `xl` | 576px | 复杂表单 |
| `2xl` | 672px | 大型表单 |
| `full` | 896px | 超大表单 |

---

## 完整示例：编辑弹窗

```tsx
// modals/example/EditExampleForm.tsx

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Loader } from 'lucide-react'

export interface EditExampleFormData {
  name: string
  description: string
  status: 'active' | 'inactive'
}

export interface EditExampleFormProps {
  onSubmit: (data: EditExampleFormData) => void
  onCancel: () => void
  initialData?: Partial<EditExampleFormData>
  submitting?: boolean
  error?: string
  // 额外 props：必须传入现有数据
  example: {
    id: string
    name: string
    description: string
    status: 'active' | 'inactive'
  }
}

export function EditExampleForm({
  onSubmit,
  onCancel,
  submitting,
  error,
  example,
}: EditExampleFormProps) {
  const [form, setForm] = useState<EditExampleFormData>({
    name: example.name,
    description: example.description,
    status: example.status,
  })

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    onSubmit(form)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* ID 只读显示 */}
      <div className="p-3 rounded-lg bg-muted/50 text-sm">
        <span className="text-muted-foreground">ID：</span>
        <code>{example.id}</code>
      </div>

      <div className="space-y-2">
        <label className="text-sm font-medium">名称 *</label>
        <Input
          value={form.name}
          onChange={(e) => setForm({ ...form, name: e.target.value })}
          required
        />
      </div>

      <div className="space-y-2">
        <label className="text-sm font-medium">描述</label>
        <Input
          value={form.description}
          onChange={(e) => setForm({ ...form, description: e.target.value })}
        />
      </div>

      <div className="space-y-2">
        <label className="text-sm font-medium">状态</label>
        <div className="flex gap-4">
          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              checked={form.status === 'active'}
              onChange={() => setForm({ ...form, status: 'active' })}
              className="accent-primary"
            />
            <span className="text-sm">启用</span>
          </label>
          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              checked={form.status === 'inactive'}
              onChange={() => setForm({ ...form, status: 'inactive' })}
              className="accent-primary"
            />
            <span className="text-sm">停用</span>
          </label>
        </div>
      </div>

      {error && (
        <div className="text-sm text-destructive bg-destructive/10 px-3 py-2 rounded-md">
          {error}
        </div>
      )}

      <div className="flex justify-end gap-3 pt-2">
        <Button type="button" variant="outline" onClick={onCancel}>
          取消
        </Button>
        <Button type="submit" disabled={submitting}>
          {submitting && <Loader className="h-4 w-4 animate-spin mr-2" />}
          保存
        </Button>
      </div>
    </form>
  )
}
```

注册：

```tsx
// registry.ts

'example.edit': {
  component: EditExampleForm,
  meta: {
    title: '编辑示例',
    width: 'lg',
  },
  onSubmit: async (data: EditExampleFormData, context) => {
    const example = context.props.example as { id: string }
    const result = await updateExample(example.id, data)
    if (!result.success) {
      throw new Error(result.error?.message || '更新失败')
    }
  },
  invalidateKeys: [['examples']],
},
```

调用：

```tsx
openModal('example.edit', { example: existingExample })
```

---

## AI 适配说明

本弹窗系统专为 AI-native 设计：

1. **AI 可以打开弹窗** - 通过 `modal:open` 事件
2. **AI 可以直接提交** - 通过 `modal:submit` 事件，完全绕过 UI
3. **AI 可以监听结果** - 通过 `modal:submit:success` / `modal:submit:error` 事件

这意味着 AI 可以：
- 让用户通过弹窗填写数据
- 直接创建/修改数据，无需人工干预
- 获取操作结果并进行后续处理

---

## 更新记录

| 日期 | 说明 |
|------|------|
| 2025-01-01 | 初始化弹窗系统架构 |

