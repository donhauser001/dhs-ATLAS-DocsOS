# æ•°æ®å—ç»„ä»¶æ’ä»¶åŒ–å¼€å‘æ ‡å‡†ä¸æ³¨å†Œæœºåˆ¶

> ç‰ˆæœ¬: 1.0.0  
> æ›´æ–°æ—¥æœŸ: 2026-01-03  
> çŠ¶æ€: âœ… å·²å®ç°

## æ¦‚è¿°

ATLAS DocsOS é‡‡ç”¨**æ’ä»¶åŒ–ç»„ä»¶æ¶æ„**ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡ç®€å•åœ°åˆ›å»ºç¬¦åˆè§„èŒƒçš„ç»„ä»¶ç›®å½•æ¥æ‰©å±•ç³»ç»ŸåŠŸèƒ½ã€‚æ¡†æ¶ä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œç»„ä»¶ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•æ¡†æ¶ä»£ç ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ”Œ **å³æ’å³ç”¨** - æ–°ç»„ä»¶åªéœ€æ”¾å…¥æŒ‡å®šç›®å½•å³å¯è‡ªåŠ¨æ³¨å†Œ
- ğŸ“¦ **æ¨¡å—éš”ç¦»** - æ¯ä¸ªç»„ä»¶ç‹¬ç«‹ç›®å½•ï¼Œäº’ä¸å¹²æ‰°
- ğŸ”§ **ç»Ÿä¸€æ¥å£** - æ ‡å‡†åŒ–çš„ç±»å‹å®šä¹‰å’Œ Props è§„èŒƒ
- ğŸ¨ **åŒè§†å›¾åˆ†ç¦»** - Controlï¼ˆæ•°æ®å—å†…æ§ä»¶ï¼‰ä¸ Configuratorï¼ˆé…ç½®å¼¹çª—ï¼‰åˆ†ç¦»

## ç›®å½•ç»“æ„

```
frontend/src/components/visual-editor/ComponentRegistry/
â”œâ”€â”€ components/                    # ç»„ä»¶ç›®å½•ï¼ˆæ¯ä¸ªå­ç›®å½•ä¸€ä¸ªç»„ä»¶ï¼‰
â”‚   â”œâ”€â”€ select/                   # ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ config.ts            # å…ƒæ•°æ® & é»˜è®¤å€¼
â”‚   â”‚   â”œâ”€â”€ Control.tsx          # æ•°æ®å—å†…æ¸²æŸ“æ§ä»¶
â”‚   â”‚   â”œâ”€â”€ Configurator.tsx     # é…ç½®å¼¹çª—è¡¨å•
â”‚   â”‚   â””â”€â”€ index.ts             # æ³¨å†Œå…¥å£ï¼ˆå¿…é¡»ï¼‰
â”‚   â”œâ”€â”€ multi-select/
â”‚   â”œâ”€â”€ rating/
â”‚   â”œâ”€â”€ number/
â”‚   â”œâ”€â”€ date/
â”‚   â”œâ”€â”€ text/
â”‚   â”œâ”€â”€ textarea/
â”‚   â”œâ”€â”€ file/
â”‚   â”œâ”€â”€ files/
â”‚   â”œâ”€â”€ image/
â”‚   â””â”€â”€ images/
â”œâ”€â”€ shared/                       # å…±äº«å·¥å…·
â”‚   â”œâ”€â”€ utils.ts                 # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ OptionEditor.tsx         # é€‰é¡¹ç¼–è¾‘å™¨ï¼ˆå¯å¤ç”¨ï¼‰
â”‚   â”œâ”€â”€ FallbackControl.tsx      # é™çº§æ§ä»¶
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ types.ts                      # ç±»å‹å®šä¹‰
â”œâ”€â”€ registry.ts                   # æ³¨å†Œä¸­å¿ƒï¼ˆè‡ªåŠ¨æ‰«æï¼‰
â”œâ”€â”€ ComponentControl.tsx          # ç»Ÿä¸€æ§ä»¶å…¥å£
â”œâ”€â”€ ComponentConfigurator.tsx     # ç»Ÿä¸€é…ç½®å™¨å…¥å£
â””â”€â”€ index.ts                      # å¯¼å‡º
```

## å¿«é€Ÿå¼€å§‹ï¼šåˆ›å»ºæ–°ç»„ä»¶

å‡è®¾è¦åˆ›å»ºä¸€ä¸ª `color-picker`ï¼ˆé¢œè‰²é€‰æ‹©å™¨ï¼‰ç»„ä»¶ï¼š

### 1. åˆ›å»ºç»„ä»¶ç›®å½•

```bash
mkdir -p frontend/src/components/visual-editor/ComponentRegistry/components/color-picker
```

### 2. å®šä¹‰ç»„ä»¶é…ç½® (config.ts)

```typescript
/**
 * ColorPicker ç»„ä»¶ - é…ç½®
 */

import { ComponentMeta } from '../../types';

// ç»„ä»¶å…ƒæ•°æ®
export const meta: ComponentMeta = {
    type: 'color-picker',        // å”¯ä¸€ç±»å‹æ ‡è¯†
    name: 'é¢œè‰²é€‰æ‹©å™¨',           // æ˜¾ç¤ºåç§°
    description: 'é€‰æ‹©é¢œè‰²å€¼',    // æè¿°
    icon: 'palette',             // Lucide å›¾æ ‡å
    hasOptions: false,           // æ˜¯å¦æœ‰é€‰é¡¹åˆ—è¡¨
};

// ç»„ä»¶å®šä¹‰ç±»å‹ï¼ˆéœ€å…ˆåœ¨ types.ts ä¸­å®šä¹‰ï¼‰
export interface ColorPickerComponentDefinition {
    type: 'color-picker';
    id: string;
    label: string;
    description?: string;
    defaultColor?: string;
    presetColors?: string[];
}

// åˆ›å»ºé»˜è®¤ç»„ä»¶å®šä¹‰
export function createDefault(id: string): ColorPickerComponentDefinition {
    return {
        type: 'color-picker',
        id,
        label: 'æ–°é¢œè‰²é€‰æ‹©',
        defaultColor: '#6366f1',
        presetColors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'],
    };
}
```

### 3. å®ç°æ•°æ®å—æ§ä»¶ (Control.tsx)

```typescript
/**
 * ColorPicker ç»„ä»¶ - æ•°æ®å—æ§ä»¶
 * 
 * åœ¨æ•°æ®å—è¡¨å•ä¸­æ¸²æŸ“çš„æ§ä»¶
 */

import { useState } from 'react';
import { ControlProps } from '../../types';
import type { ColorPickerComponentDefinition } from './config';

export function Control({ component, value, onChange, disabled }: ControlProps) {
    const colorDef = component as ColorPickerComponentDefinition;
    const currentColor = (value as string) || colorDef.defaultColor || '#000000';

    return (
        <div className="flex items-center gap-2">
            <input
                type="color"
                value={currentColor}
                onChange={(e) => onChange(e.target.value)}
                disabled={disabled}
                className="w-10 h-10 rounded border cursor-pointer"
            />
            <span className="text-sm font-mono text-slate-600">{currentColor}</span>
            
            {/* é¢„è®¾é¢œè‰² */}
            {colorDef.presetColors && (
                <div className="flex gap-1 ml-2">
                    {colorDef.presetColors.map((color) => (
                        <button
                            key={color}
                            type="button"
                            onClick={() => onChange(color)}
                            disabled={disabled}
                            className="w-6 h-6 rounded border-2 border-white shadow"
                            style={{ backgroundColor: color }}
                        />
                    ))}
                </div>
            )}
        </div>
    );
}

export default Control;
```

### 4. å®ç°é…ç½®è¡¨å• (Configurator.tsx)

```typescript
/**
 * ColorPicker ç»„ä»¶ - é…ç½®è¡¨å•
 * 
 * åœ¨ç»„ä»¶é…ç½®å¼¹çª—ä¸­æ¸²æŸ“çš„è¡¨å•
 */

import { ConfiguratorProps } from '../../types';
import type { ColorPickerComponentDefinition } from './config';

export function Configurator({ formData, errors, onUpdateFormData }: ConfiguratorProps) {
    const colorData = formData as ColorPickerComponentDefinition;

    return (
        <div className="space-y-4">
            {/* é»˜è®¤é¢œè‰² */}
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    é»˜è®¤é¢œè‰²
                </label>
                <input
                    type="color"
                    value={colorData.defaultColor || '#000000'}
                    onChange={(e) =>
                        onUpdateFormData((prev) => ({
                            ...prev,
                            defaultColor: e.target.value,
                        } as ColorPickerComponentDefinition))
                    }
                    className="w-full h-10 rounded border cursor-pointer"
                />
            </div>

            {/* é¢„è®¾é¢œè‰²ç¼–è¾‘ */}
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    é¢„è®¾é¢œè‰²ï¼ˆé€—å·åˆ†éš”ï¼‰
                </label>
                <input
                    type="text"
                    value={(colorData.presetColors || []).join(', ')}
                    onChange={(e) =>
                        onUpdateFormData((prev) => ({
                            ...prev,
                            presetColors: e.target.value.split(',').map(c => c.trim()).filter(Boolean),
                        } as ColorPickerComponentDefinition))
                    }
                    placeholder="#ef4444, #f59e0b, #10b981"
                    className="w-full px-3 py-2 border rounded-lg text-sm"
                />
            </div>
        </div>
    );
}

export default Configurator;
```

### 5. åˆ›å»ºæ³¨å†Œå…¥å£ (index.ts)

```typescript
/**
 * ColorPicker ç»„ä»¶ - æ³¨å†Œå…¥å£
 * 
 * âš ï¸ å¿…é¡»é»˜è®¤å¯¼å‡º RegisteredComponent å¯¹è±¡
 */

import { RegisteredComponent } from '../../types';
import { meta, createDefault } from './config';
import { Control } from './Control';
import { Configurator } from './Configurator';

const ColorPickerComponent: RegisteredComponent = {
    meta,
    createDefault,
    Control,
    Configurator,
};

export default ColorPickerComponent;
```

### 6. æ›´æ–°ç±»å‹å®šä¹‰ (types.ts)

åœ¨ `ComponentRegistry/types.ts` ä¸­æ·»åŠ æ–°ç±»å‹ï¼š

```typescript
// åœ¨ ComponentType ä¸­æ·»åŠ 
export type ComponentType =
    | 'select'
    | 'multi-select'
    // ... å…¶ä»–ç±»å‹
    | 'color-picker';  // æ–°å¢

// æ·»åŠ ç»„ä»¶å®šä¹‰æ¥å£
export interface ColorPickerComponentDefinition extends BaseComponentDefinition {
    type: 'color-picker';
    defaultColor?: string;
    presetColors?: string[];
}

// åœ¨è”åˆç±»å‹ä¸­æ·»åŠ 
export type DocumentComponentDefinition =
    | SelectComponentDefinition
    // ... å…¶ä»–ç±»å‹
    | ColorPickerComponentDefinition;  // æ–°å¢
```

### 7. å®Œæˆï¼

ä¿å­˜æ–‡ä»¶åï¼Œç»„ä»¶ä¼šè‡ªåŠ¨è¢«æ³¨å†Œã€‚åœ¨æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼š

```
[ComponentRegistry] Registered: color-picker
```

## æ ¸å¿ƒç±»å‹å®šä¹‰

### ComponentMetaï¼ˆç»„ä»¶å…ƒæ•°æ®ï¼‰

```typescript
interface ComponentMeta {
    type: ComponentType;      // å”¯ä¸€ç±»å‹æ ‡è¯†
    name: string;            // æ˜¾ç¤ºåç§°
    description: string;     // æè¿°
    icon: string;           // Lucide å›¾æ ‡å
    hasOptions: boolean;    // æ˜¯å¦æœ‰é€‰é¡¹åˆ—è¡¨ï¼ˆå¦‚ä¸‹æ‹‰èœå•ï¼‰
}
```

### ControlPropsï¼ˆæ§ä»¶ Propsï¼‰

```typescript
interface ControlProps {
    component: DocumentComponentDefinition;  // ç»„ä»¶å®šä¹‰
    value: string | string[] | number | null | undefined;  // å½“å‰å€¼
    onChange: (value: string | string[] | number | null) => void;  // å€¼å˜æ›´å›è°ƒ
    disabled?: boolean;  // æ˜¯å¦ç¦ç”¨
}
```

### ConfiguratorPropsï¼ˆé…ç½®å™¨ Propsï¼‰

```typescript
interface ConfiguratorProps {
    formData: DocumentComponentDefinition;  // ç»„ä»¶å®šä¹‰
    errors: Record<string, string>;  // é”™è¯¯ä¿¡æ¯
    onUpdateFormData: (updater: (prev: DocumentComponentDefinition) => DocumentComponentDefinition) => void;
}
```

### RegisteredComponentï¼ˆæ³¨å†Œç»„ä»¶ï¼‰

```typescript
interface RegisteredComponent {
    meta: ComponentMeta;
    createDefault: (id: string) => DocumentComponentDefinition;
    Control: React.ComponentType<ControlProps>;
    Configurator: React.ComponentType<ConfiguratorProps>;
}
```

## è‡ªåŠ¨æ³¨å†Œæœºåˆ¶

æ¡†æ¶ä½¿ç”¨ Vite çš„ `import.meta.glob` å®ç°è‡ªåŠ¨æ‰«æï¼š

```typescript
// registry.ts
const componentModules = import.meta.glob<{ default: RegisteredComponent }>(
    './components/*/index.ts',
    { eager: true }
);

for (const [path, module] of Object.entries(componentModules)) {
    const component = module.default;
    if (component && component.meta && component.meta.type) {
        registry.set(component.meta.type, component);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- æ‰«æ `components/*/index.ts` æ¨¡å¼
- å¿…é¡»é»˜è®¤å¯¼å‡º `RegisteredComponent` å¯¹è±¡
- ä½¿ç”¨ `eager: true` åŒæ­¥åŠ è½½

## API ä½¿ç”¨

### è·å–ç»„ä»¶

```typescript
import { 
    getComponent,
    getComponentMeta,
    getControl,
    getConfigurator,
    createDefaultComponent,
    isRegistered,
} from '@/components/visual-editor/ComponentRegistry';

// è·å–å®Œæ•´æ³¨å†Œä¿¡æ¯
const selectComponent = getComponent('select');

// è·å–å…ƒæ•°æ®
const meta = getComponentMeta('select');

// è·å–æ§ä»¶ç»„ä»¶
const SelectControl = getControl('select');

// è·å–é…ç½®å™¨ç»„ä»¶
const SelectConfigurator = getConfigurator('select');

// åˆ›å»ºé»˜è®¤ç»„ä»¶å®šä¹‰
const newSelect = createDefaultComponent('select', 'comp-123');

// æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
if (isRegistered('color-picker')) {
    // ...
}
```

### åŠ¨æ€æ³¨å†Œï¼ˆè¿è¡Œæ—¶ï¼‰

```typescript
import { registerComponent, unregisterComponent } from '@/components/visual-editor/ComponentRegistry';

// æ³¨å†Œ
registerComponent(myCustomComponent);

// æ³¨é”€
unregisterComponent('my-custom');
```

## å…±äº«å·¥å…·

### OptionEditor

ç”¨äºç¼–è¾‘é€‰é¡¹åˆ—è¡¨çš„å¯å¤ç”¨ç»„ä»¶ï¼š

```typescript
import { OptionEditor } from '../../shared';

<OptionEditor
    options={selectData.options || []}
    onChange={(options) =>
        onUpdateFormData((prev) => ({ ...prev, options }))
    }
/>
```

### getLucideIcon

åŠ¨æ€è·å– Lucide å›¾æ ‡ï¼š

```typescript
import { getLucideIcon } from '../../shared';

const Icon = getLucideIcon('chevron-down');
if (Icon) {
    return <Icon size={16} />;
}
```

### generateComponentId

ç”Ÿæˆå”¯ä¸€ç»„ä»¶ IDï¼š

```typescript
import { generateComponentId } from '../../shared';

const id = generateComponentId(); // ä¾‹å¦‚: "comp_abc123"
```

### FallbackControl

å½“ç»„ä»¶æœªæ‰¾åˆ°æ—¶çš„é™çº§æ§ä»¶ï¼š

```typescript
import { FallbackControl } from '../../shared';

<FallbackControl
    componentId={componentId}
    value={value}
    onChange={onChange}
/>
```

## æœ€ä½³å®è·µ

### 1. ç±»å‹å®‰å…¨

å§‹ç»ˆåœ¨ `Control.tsx` å’Œ `Configurator.tsx` ä¸­è¿›è¡Œç±»å‹æ–­è¨€ï¼š

```typescript
const selectDef = component as SelectComponentDefinition;
```

### 2. ä¼˜é›…é™çº§

å¤„ç†å¯èƒ½ç¼ºå¤±çš„é…ç½®å€¼ï¼š

```typescript
const options = selectDef.options || [];
const max = ratingDef.max ?? 5;
```

### 3. Portal æ¸²æŸ“ä¸‹æ‹‰èœå•

ä½¿ç”¨ `createPortal` æ¸²æŸ“ä¸‹æ‹‰èœå•ï¼Œé¿å…è¢«çˆ¶å®¹å™¨è£å‰ªï¼š

```typescript
import { createPortal } from 'react-dom';

{isOpen && createPortal(
    <div className="dropdown">...</div>,
    document.body
)}
```

### 4. ç‚¹å‡»å¤–éƒ¨å…³é—­

å®ç°ç‚¹å‡»å¤–éƒ¨å…³é—­çš„æ ‡å‡†æ¨¡å¼ï¼š

```typescript
useEffect(() => {
    if (!isOpen) return;
    const handleClickOutside = (e: MouseEvent) => {
        if (triggerRef.current && !triggerRef.current.contains(e.target as Node)) {
            setIsOpen(false);
        }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
}, [isOpen]);
```

### 5. æ ·å¼ä¸€è‡´æ€§

ä½¿ç”¨é¡¹ç›®ä¸­çš„ `cn()` å·¥å…·å’Œ Tailwind CSSï¼š

```typescript
import { cn } from '@/lib/utils';

<button className={cn(
    'base-styles',
    isActive && 'active-styles',
    disabled && 'disabled-styles'
)}>
```

## å†…ç½®ç»„ä»¶åˆ—è¡¨

| ç±»å‹ | åç§° | æè¿° | å›¾æ ‡ |
|------|------|------|------|
| `select` | ä¸‹æ‹‰é€‰æ‹© | å•é€‰ä¸‹æ‹‰èœå• | chevron-down |
| `multi-select` | å¤šé€‰ä¸‹æ‹‰ | å¤šé€‰ä¸‹æ‹‰èœå• | list |
| `radio` | å•é€‰æŒ‰é’® | å•é€‰æŒ‰é’®ç»„ | circle-dot |
| `checkbox` | å¤é€‰æ¡† | å¤é€‰æ¡†ç»„ | check-square |
| `rating` | è¯„åˆ† | æ˜Ÿçº§è¯„åˆ† | star |
| `number` | æ•°å­—è¾“å…¥ | æ•°å­—è¾“å…¥æ¡† | hash |
| `date` | æ—¥æœŸé€‰æ‹© | æ—¥æœŸé€‰æ‹©å™¨ | calendar |
| `text` | å•è¡Œæ–‡æœ¬ | å•è¡Œæ–‡æœ¬è¾“å…¥ | type |
| `textarea` | å¤šè¡Œæ–‡æœ¬ | å¤šè¡Œæ–‡æœ¬è¾“å…¥ | align-left |
| `file` | å•æ–‡ä»¶ | å•æ–‡ä»¶é€‰æ‹© | file |
| `files` | å¤šæ–‡ä»¶ | å¤šæ–‡ä»¶é€‰æ‹© | files |
| `image` | å•å›¾ç‰‡ | å•å›¾ç‰‡é€‰æ‹© | image |
| `images` | å¤šå›¾ç‰‡ | å¤šå›¾ç‰‡é€‰æ‹© | gallery-horizontal |

## æ•…éšœæ’æŸ¥

### ç»„ä»¶æœªè‡ªåŠ¨æ³¨å†Œ

1. æ£€æŸ¥ç›®å½•ç»“æ„æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿ `index.ts` é»˜è®¤å¯¼å‡º `RegisteredComponent` å¯¹è±¡
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
4. ç¡®è®¤ `meta.type` å·²æ·»åŠ åˆ° `ComponentType` è”åˆç±»å‹

### ç±»å‹é”™è¯¯

1. ç¡®ä¿åœ¨ `types.ts` ä¸­å®šä¹‰äº†ç»„ä»¶å®šä¹‰æ¥å£
2. ç¡®ä¿æ·»åŠ åˆ°äº† `DocumentComponentDefinition` è”åˆç±»å‹
3. ä½¿ç”¨æ­£ç¡®çš„ç±»å‹æ–­è¨€

### æ§ä»¶ä¸æ˜¾ç¤º

1. æ£€æŸ¥ `Control.tsx` æ˜¯å¦æ­£ç¡®å¯¼å‡º
2. æ£€æŸ¥ `ControlProps` æ˜¯å¦æ­£ç¡®ä½¿ç”¨
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ¸²æŸ“é”™è¯¯

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [Phase 3.8 - å¯è§†åŒ–æ–‡æ¡£ç¼–è¾‘å™¨](./Phase-3.8-å¯è§†åŒ–æ–‡æ¡£ç¼–è¾‘å™¨.md)
- [Phase 3.9 - æ–‡ä»¶ç®¡ç†ç»„ä»¶](./Phase-3.9-æ–‡ä»¶ç®¡ç†ç»„ä»¶.md)

