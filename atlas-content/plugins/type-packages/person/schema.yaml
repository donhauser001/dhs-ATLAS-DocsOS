# Person 数据校验规则（核心字段合同）
# 定义成为 Verified Person 和 Login Eligible 的最低要求

version: "1.0"

# ============================================================
# 核心字段合同
# ============================================================

# 成为「Verified Person」的最低合同
verified_contract:
  name: "Verified Person 合同"
  description: "必须全部满足才能从 staging 升级到 verified"
  
  requirements:
    # 1. display_name 必须存在
    - field: "display_name"
      rule: "required"
      message: "显示名称是必填项"
      
    # 2. 至少一个可联系字段存在（email OR phone）
    - rule: "at_least_one"
      fields: ["email", "phone"]
      message: "请至少填写邮箱或手机号中的一项"

# 成为「可登录主体」的最低合同（附加）
login_eligible_contract:
  name: "Login Eligible 合同"
  description: "在 Verified 基础上，额外必须满足"
  
  extends: "verified_contract"
  
  requirements:
    # 1. 联系方式已验证
    - field: "contact_verified"
      rule: "equals"
      value: true
      message: "联系方式必须经过验证"
      
    # 2. 显式启用登录
    - field: "access.enabled"
      rule: "equals"
      value: true
      message: "必须显式启用登录权限"

# ============================================================
# 字段校验规则
# ============================================================

fields:
  # 唯一标识
  id:
    type: string
    required: true
    auto_generate: true
    pattern: "^[a-zA-Z0-9_-]+$"
    message: "ID 只能包含字母、数字、下划线和连字符"
    
  # 显示名称（核心必填）
  display_name:
    type: string
    required: true
    min_length: 1
    max_length: 100
    message: "显示名称不能为空，且长度不超过100个字符"
    
  # 邮箱（可联系字段之一）
  email:
    type: string
    pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    message: "请输入有效的邮箱地址"
    unique: true
    unique_scope: "person"
    
  # 手机号（可联系字段之一）
  phone:
    type: string
    pattern: "^1[3-9]\\d{9}$"
    message: "请输入有效的手机号码"
    unique: true
    unique_scope: "person"
    
  # 头像
  avatar:
    type: file
    accept: ["image/jpeg", "image/png", "image/gif", "image/webp"]
    max_size: "5MB"
    
  # 职位
  title:
    type: string
    max_length: 50
    
  # 公司
  company:
    type: string
    max_length: 100
    
  # 部门
  department:
    type: string
    max_length: 50
    
  # 标签
  tags:
    type: array
    items:
      type: string
      max_length: 20
      
  # 状态
  status:
    type: string
    enum: ["active", "inactive", "archived"]
    default: "active"

# ============================================================
# 访问控制字段
# ============================================================

access_fields:
  # 登录状态
  access_status:
    type: string
    enum: ["none", "eligible", "invited", "active", "suspended"]
    default: "none"
    
  # 是否启用登录
  access_enabled:
    type: boolean
    default: false
    
  # 联系方式是否已验证
  contact_verified:
    type: boolean
    default: false
    
  # 密码哈希（加密存储）
  password_hash:
    type: string
    sensitive: true
    indexed: false
    
  # 邀请 token
  invite_token:
    type: string
    sensitive: true
    indexed: false
    expires: true
    
  # 最后登录时间
  last_login:
    type: datetime
    indexed: true

# ============================================================
# 联合校验规则
# ============================================================

rules:
  # 进入 staging 的最低要求
  - name: "staging_minimum"
    condition: "doc_type === 'person'"
    message: "必须声明 doc-type: person"
    level: "error"
    
  # 唯一性冲突检查
  - name: "email_unique"
    condition: "!existsInIndex('person', 'email', email)"
    message: "该邮箱已被其他人员使用"
    level: "warning"
    action: "flag_conflict"
    
  - name: "phone_unique"
    condition: "!existsInIndex('person', 'phone', phone)"
    message: "该手机号已被其他人员使用"
    level: "warning"
    action: "flag_conflict"

# ============================================================
# 自动填充规则
# ============================================================

auto_fill:
  id:
    value: "{{generateId('person')}}"
    on: "create"
    
  created_at:
    value: "{{now}}"
    on: "create"
    
  updated_at:
    value: "{{now}}"
    on: "update"
    
  access_status:
    value: "none"
    on: "create"
    condition: "!access_status"


