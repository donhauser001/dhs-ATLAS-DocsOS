# 用户数据校验规则
# 定义用户文档的数据校验

version: "1.0"

# ============================================================
# 必填字段
# ============================================================

required:
  - name

# ============================================================
# 字段校验规则
# ============================================================

fields:
  # 姓名
  name:
    type: string
    required: true
    min_length: 1
    max_length: 100
    message: "姓名不能为空，且长度不超过100个字符"
    
  # 邮箱
  email:
    type: string
    pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    message: "请输入有效的邮箱地址"
    unique: true
    unique_scope: "user"
    
  # 手机号
  phone:
    type: string
    pattern: "^1[3-9]\\d{9}$"
    message: "请输入有效的手机号码"
    unique: true
    unique_scope: "user"
    
  # 生日
  birthday:
    type: date
    max: "{{today}}"
    message: "生日不能晚于今天"
    
  # 头像
  avatar:
    type: file
    accept: ["image/jpeg", "image/png", "image/gif", "image/webp"]
    max_size: "5MB"
    
  # 职位
  title:
    type: string
    max_length: 50
    
  # 公司
  company:
    type: string
    max_length: 100
    
  # 部门
  department:
    type: string
    max_length: 50
    
  # 标签
  tags:
    type: array
    items:
      type: string
      max_length: 20

# ============================================================
# 认证字段校验
# ============================================================

auth_fields:
  # 用户ID
  user_id:
    type: string
    pattern: "^[a-zA-Z0-9_-]+$"
    unique: true
    auto_generate: true
    
  # 用户名
  username:
    type: string
    min_length: 3
    max_length: 50
    pattern: "^[a-zA-Z0-9_]+$"
    unique: true
    message: "用户名只能包含字母、数字和下划线"
    
  # 角色
  role:
    type: string
    enum: ["admin", "manager", "staff", "customer", "guest"]
    default: "customer"
    
  # 状态
  status:
    type: string
    enum: ["active", "inactive", "suspended"]
    default: "active"

# ============================================================
# 联合校验规则
# ============================================================

rules:
  # 至少需要一种联系方式
  - name: "at_least_one_contact"
    condition: "phone || email || mobile"
    message: "请至少填写一种联系方式"
    level: "warning"
    
  # 邮箱唯一性
  - name: "email_unique"
    condition: "!existsInIndex('user', 'email', email)"
    message: "该邮箱已被其他用户使用"
    level: "warning"
    action: "flag_conflict"
    
  # 手机号唯一性
  - name: "phone_unique"
    condition: "!existsInIndex('user', 'phone', phone)"
    message: "该手机号已被其他用户使用"
    level: "warning"
    action: "flag_conflict"

# ============================================================
# 自动填充规则
# ============================================================

auto_fill:
  id:
    value: "{{generateId('user')}}"
    on: "create"
    
  created_at:
    value: "{{now}}"
    on: "create"
    
  updated_at:
    value: "{{now}}"
    on: "update"
